<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Avatar - Planes de Estudio</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f2f5; padding:20px; }
    h1 { color:#2e86de; text-align:center; }
    nav { text-align:center; margin-bottom:30px; }
    nav a { margin:10px; text-decoration:none; color:#444; font-weight:bold; }
    nav a:hover { color:#2e86de; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:white; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#2e86de; color:white; }
    tr:nth-child(even){ background:#f9f9f9; }
    .actions { display:flex; gap:5px; justify-content:center; }
    .btn { padding:5px 10px; border:none; border-radius:3px; cursor:pointer; }
    .btn-edit { background:#f39c12; color:white; }
    .btn-delete { background:#e74c3c; color:white; }
    .btn-add { background:#27ae60; color:white; padding:10px 15px; margin-bottom:20px; }
    .btn-view { background:#3498db; color:white; }
    .status-active { color:#27ae60; font-weight:bold; }
    .status-inactive { color:#e74c3c; font-weight:bold; }
    /* Modal */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); }
    .modal-content { background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:50%; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    .close { float:right; font-size:28px; cursor:pointer; color:#aaa; }
    .close:hover { color:black; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:bold; }
    .form-group input, .form-group select { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; }
    .form-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
    .error { color:#e74c3c; font-size:14px; margin-top:5px; }
  </style>
</head>
<body>
  <h1>Gestión de Planes de Estudio</h1>

  <nav>
    <a href="index.html">Inicio</a>
    <a href="usuarios.html">Usuarios</a>
    <a href="estudiantes.html">Estudiantes</a>
    <a href="profesores.html">Profesores</a>
    <a href="materias.html">Materias</a>
    <a href="planes.html">Planes</a>
    <a href="matricula.html">Matrícula</a>
    <a href="pagos.html">Pagos</a>
    <a href="configuracion.html">Configuración</a>
  </nav>

  <div style="text-align:right;">
    <button class="btn btn-add" onclick="abrirModal()">+ Agregar Plan</button>
  </div>

  <table id="planesTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Año Inicio</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Cargando planes...</td></tr>
    </tbody>
  </table>

  <!-- Modal -->
  <div id="planModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h2 id="modalTitle">Agregar Plan</h2>
      <form id="planForm">
        <input type="hidden" id="planId">

        <div class="form-group">
          <label for="nombrePlan">Nombre del Plan:</label>
          <input type="text" id="nombrePlan" required>
          <div id="nombrePlanError" class="error"></div>
        </div>

        <div class="form-group">
          <label for="anioInicio">Año de Inicio:</label>
          <input type="number" id="anioInicio" min="2000" max="2100" required>
          <div id="anioInicioError" class="error"></div>
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select id="estado" required>
            <option value="1">Activo</option>
            <option value="0">Inactivo</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-add">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let planesData = [];
    let modoEdicion = false;

    // ==== Cargar planes ====
    async function cargarPlanes() {
      const token = localStorage.getItem('token');
      if (!token) { window.location.href = 'login.html'; return; }

      try {
        const res = await fetch('/api/planes', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
          alert('Sesión expirada, inicie sesión de nuevo.');
          localStorage.removeItem('token');
          return window.location.href = 'login.html';
        }

        const data = await res.json();
        const tbody = document.querySelector('#planesTable tbody');
        tbody.innerHTML = '';

        if (!data.success || data.planes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No hay planes registrados</td></tr>';
          return;
        }

        planesData = data.planes;
        planesData.forEach(plan => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${plan.PlanID}</td>
            <td>${plan.NombrePlan}</td>
            <td>${plan.AnioInicio}</td>
            <td class="${plan.Estado ? 'status-active':'status-inactive'}">
              ${plan.Estado ? 'Activo':'Inactivo'}
            </td>
            <td class="actions">
              <button class="btn btn-view" onclick="verMateriasPlan(${plan.PlanID})">Materias</button>
              <button class="btn btn-edit" onclick="editarPlan(${plan.PlanID})">Editar</button>
              <button class="btn btn-delete" onclick="desactivarPlan(${plan.PlanID})">Desactivar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('Error al cargar planes.');
      }
    }

    // ==== Abrir modal ====
    function abrirModal() {
      modoEdicion = false;
      document.getElementById('modalTitle').textContent = 'Agregar Plan';
      document.getElementById('planForm').reset();
      document.getElementById('planId').value = '';
      document.getElementById('anioInicio').value = new Date().getFullYear();
      document.getElementById('planModal').style.display = 'block';
    }

    function cerrarModal() { document.getElementById('planModal').style.display = 'none'; }

    // ==== Editar plan ====
    function editarPlan(id) {
      const plan = planesData.find(p => p.PlanID === id);
      if (!plan) return;
      modoEdicion = true;
      document.getElementById('modalTitle').textContent = 'Editar Plan';
      document.getElementById('planId').value = plan.PlanID;
      document.getElementById('nombrePlan').value = plan.NombrePlan;
      document.getElementById('anioInicio').value = plan.AnioInicio;
      document.getElementById('estado').value = plan.Estado ? '1':'0';
      document.getElementById('planModal').style.display = 'block';
    }

    // ==== Guardar plan ====
    async function enviarFormulario(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');
      if (!token) return window.location.href = 'login.html';

      const planData = {
        NombrePlan: document.getElementById('nombrePlan').value.trim(),
        AnioInicio: parseInt(document.getElementById('anioInicio').value),
        Estado: parseInt(document.getElementById('estado').value)
      };

      let url = '/api/planes';
      let method = 'POST';
      const id = document.getElementById('planId').value;
      if (modoEdicion && id) { url = `/api/planes/${id}`; method = 'PUT'; }

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
          body: JSON.stringify(planData)
        });

        const data = await res.json();
        if (res.ok && data.success) {
          alert(`Plan ${modoEdicion ? 'actualizado':'creado'} correctamente`);
          cerrarModal();
          cargarPlanes();
        } else {
          alert(data.message || 'Error al guardar');
        }
      } catch (err) {
        console.error(err);
        alert('Error de conexión');
      }
    }

    // ==== Desactivar plan ====
    async function desactivarPlan(id) {
      if (!confirm('¿Desea desactivar este plan?')) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/planes/${id}/inactivar`, {
          method:'PUT',
          headers:{ 'Authorization':`Bearer ${token}` }
        });
        const data = await res.json();
        if (res.ok && data.success) {
          alert('Plan desactivado');
          cargarPlanes();
        } else {
          alert(data.message || 'Error al desactivar');
        }
      } catch (err) {
        console.error(err);
        alert('Error de conexión');
      }
    }

    // ==== Ver materias de un plan ====
    function verMateriasPlan(id) { window.location.href = `materias_plan.html?plan=${id}`; }

    // ==== Init ====
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) return window.location.href = 'login.html';
      cargarPlanes();
      document.getElementById('planForm').addEventListener('submit', enviarFormulario);
      window.addEventListener('click', e => { if (e.target === document.getElementById('planModal')) cerrarModal(); });
    });
  </script>
</body>
</html>
