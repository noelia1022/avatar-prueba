<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Avatar - Planes de Estudio</title>
  <style>
    /* Estilos permanecen igual */
  </style>
</head>
<body>
  <h1>Gestión de Planes de Estudio</h1>

  <nav>
    <!-- Navegación permanece igual -->
  </nav>

  <div style="text-align:right;">
    <button class="btn btn-add" onclick="abrirModal()">+ Agregar Plan</button>
  </div>

  <table id="planesTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Año Inicio</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Cargando planes...</td></tr>
    </tbody>
  </table>

  <!-- Modal -->
  <div id="planModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h2 id="modalTitle">Agregar Plan</h2>
      <form id="planForm">
        <input type="hidden" id="planId">

        <div class="form-group">
          <label for="nombrePlan">Nombre del Plan:</label>
          <input type="text" id="nombrePlan" required>
          <div id="nombrePlanError" class="error"></div>
        </div>

        <div class="form-group">
          <label for="anioInicio">Año de Inicio:</label>
          <input type="number" id="anioInicio" min="2000" max="2100" required>
          <div id="anioInicioError" class="error"></div>
        </div>

        <div class="form-group">
          <label for="estado">Estado:</label>
          <select id="estado" required>
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-add">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let planesData = [];
    let modoEdicion = false;

    // ==== Cargar planes ====
    async function cargarPlanes() {
      const token = localStorage.getItem('token');
      if (!token) { window.location.href = 'login.html'; return; } // Cambiado a login.html

      try {
        const res = await fetch('/api/planes', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
          alert('Sesión expirada, inicie sesión de nuevo.');
          localStorage.removeItem('token');
          return window.location.href = 'login.html'; // Cambiado a login.html
        }

        const data = await res.json();
        const tbody = document.querySelector('#planesTable tbody');
        tbody.innerHTML = '';

        if (!data.success || data.planes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No hay planes registrados</td></tr>';
          return;
        }

        planesData = data.planes;
        planesData.forEach(plan => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${plan.planid}</td>
            <td>${plan.nombreplan}</td>
            <td>${plan.anioinicio}</td>
            <td class="${plan.estado ? 'status-active':'status-inactive'}">
              ${plan.estado ? 'Activo':'Inactivo'}
            </td>
            <td class="actions">
              <button class="btn btn-view" onclick="verMateriasPlan(${plan.planid})">Materias</button>
              <button class="btn btn-edit" onclick="editarPlan(${plan.planid})">Editar</button>
              <button class="btn btn-delete" onclick="desactivarPlan(${plan.planid})">Desactivar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('Error al cargar planes.');
      }
    }

    // ==== Abrir modal ====
    function abrirModal() {
      modoEdicion = false;
      document.getElementById('modalTitle').textContent = 'Agregar Plan';
      document.getElementById('planForm').reset();
      document.getElementById('planId').value = '';
      document.getElementById('anioInicio').value = new Date().getFullYear();
      document.getElementById('planModal').style.display = 'block';
    }

    function cerrarModal() { document.getElementById('planModal').style.display = 'none'; }

    // ==== Editar plan ====
    function editarPlan(id) {
      const plan = planesData.find(p => p.planid === id);
      if (!plan) return;
      modoEdicion = true;
      document.getElementById('modalTitle').textContent = 'Editar Plan';
      document.getElementById('planId').value = plan.planid;
      document.getElementById('nombrePlan').value = plan.nombreplan;
      document.getElementById('anioInicio').value = plan.anioinicio;
      document.getElementById('estado').value = plan.estado ? 'true':'false';
      document.getElementById('planModal').style.display = 'block';
    }

    // ==== Guardar plan ====
    async function enviarFormulario(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');
      if (!token) return window.location.href = 'login.html'; // Cambiado a login.html

      const planData = {
        nombreplan: document.getElementById('nombrePlan').value.trim(),
        anioinicio: parseInt(document.getElementById('anioInicio').value),
        estado: document.getElementById('estado').value === 'true'
      };

      let url = '/api/planes';
      let method = 'POST';
      const id = document.getElementById('planId').value;
      if (modoEdicion && id) { url = `/api/planes/${id}`; method = 'PUT'; }

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
          body: JSON.stringify(planData)
        });

        const data = await res.json();
        if (res.ok && data.success) {
          alert(`Plan ${modoEdicion ? 'actualizado':'creado'} correctamente`);
          cerrarModal();
          cargarPlanes();
        } else {
          alert(data.message || 'Error al guardar');
        }
      } catch (err) {
        console.error(err);
        alert('Error de conexión');
      }
    }

    // ==== Desactivar plan ====
    async function desactivarPlan(id) {
      if (!confirm('¿Desea desactivar este plan?')) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/planes/${id}/inactivar`, {
          method:'PUT',
          headers:{ 'Authorization':`Bearer ${token}` }
        });
        const data = await res.json();
        if (res.ok && data.success) {
          alert('Plan desactivado');
          cargarPlanes();
        } else {
          alert(data.message || 'Error al desactivar');
        }
      } catch (err) {
        console.error(err);
        alert('Error de conexión');
      }
    }

    // ==== Ver materias de un plan ====
    function verMateriasPlan(id) { window.location.href = `materias_plan.html?plan=${id}`; }

    // ==== Init ====
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) return window.location.href = 'login.html'; // Cambiado a login.html
      cargarPlanes();
      document.getElementById('planForm').addEventListener('submit', enviarFormulario);
      window.addEventListener('click', e => { if (e.target === document.getElementById('planModal')) cerrarModal(); });
    });
  </script>
</body>
</html>