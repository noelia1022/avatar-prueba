<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Avatar - Materias</title>
  <style>
    /* Estilos permanecen igual */
  </style>
</head>
<body>
  <!-- Contenido permanece igual -->

  <script>
    // Código actualizado
    const token = localStorage.getItem('token');
    let user;
    try {
      user = JSON.parse(localStorage.getItem('user')) || {};
    } catch { user = {}; }

    if(!token) {
      alert('Debe iniciar sesión primero');
      window.location.href = 'login.html'; // Cambiado a login.html
    } else {
      document.getElementById('userName').textContent = user.nombre || '';
    }

    let todasLasMaterias = [];
    let planesEstudio = [];

    async function cargarPlanes() {
      try {
        const res = await fetch('/api/planes', { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await res.json();
        if(result.success) {
          planesEstudio = result.planes;
          const select = document.getElementById('planFilter');
          select.innerHTML = '<option value="0">Todos los planes</option>';
          planesEstudio.forEach(plan => {
            const opt = document.createElement('option');
            opt.value = plan.planid;
            opt.textContent = plan.nombreplan;
            select.appendChild(opt);
          });
        }
      } catch (err) {
        console.error('Error al cargar planes:', err);
        alert('Error al cargar planes de estudio');
      }
    }

    async function cargarMaterias() {
      try {
        const res = await fetch('/api/materias', { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await res.json();
        if(result.success) {
          todasLasMaterias = result.materias;
          filtrarMaterias();
        } else {
          throw new Error(result.message || 'Error al obtener materias');
        }
      } catch (err) {
        console.error('Error al cargar materias:', err);
        const loadingText = document.getElementById('loadingText');
        loadingText.textContent = 'Error al cargar materias: ' + err.message;
        loadingText.style.color = '#e74c3c';
      }
    }

    function filtrarMaterias() {
      const planID = document.getElementById('planFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      let materiasFiltradas = todasLasMaterias;
      if(planID !== "0") materiasFiltradas = materiasFiltradas.filter(m => m.planid == planID);
      if(statusFilter !== "all") {
        const estadoFiltro = statusFilter === "active";
        materiasFiltradas = materiasFiltradas.filter(m => m.estado === estadoFiltro);
      }

      const tbody = document.querySelector('#materiasTable tbody');
      tbody.innerHTML = '';

      if(materiasFiltradas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="no-data">No se encontraron materias</td></tr>`;
        return;
      }

      materiasFiltradas.forEach(m => {
        const plan = planesEstudio.find(p => p.planid == m.planid) || {};
        const isActive = m.estado !== undefined ? m.estado : true;
        const statusClass = isActive ? 'status-active' : 'status-inactive';
        const statusText = isActive ? 'Activa' : 'Inactiva';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${m.codigo}</td>
          <td>${m.nombre}</td>
          <td>${m.creditos}</td>
          <td>${plan.nombreplan || 'No asignado'}</td>
          <td class="${statusClass}">${statusText}</td>
          <td class="actions">
            <button class="btn btn-edit" onclick="editarMateria('${m.codigo}')">Editar</button>
            ${isActive 
              ? `<button class="btn btn-deactivate" onclick="cambiarEstadoMateria('${m.codigo}', false)">Desactivar</button>`
              : `<button class="btn btn-activate" onclick="cambiarEstadoMateria('${m.codigo}', true)">Activar</button>`
            }
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function editarMateria(codigo) {
      location.href = `agregar_materia.html?codigo=${codigo}`;
    }

    async function cambiarEstadoMateria(codigo, nuevoEstado) {
      const accion = nuevoEstado ? "activar" : "desactivar";
      if(confirm(`¿Está seguro de ${accion} esta materia?`)) {
        try {
          const res = await fetch(`/api/materias/${codigo}/estado`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ activo: nuevoEstado })
          });
          const result = await res.json();
          if(res.ok && result.success) {
            alert(`Materia ${accion}ada correctamente`);
            cargarMaterias();
          } else {
            alert(`Error al ${accion} materia: ` + (result.message || ''));
          }
        } catch (err) {
          console.error(`Error al ${accion} materia:`, err);
          alert(`Error al ${accion} materia`);
        }
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html'; // Cambiado a login.html
    }

    document.addEventListener('DOMContentLoaded', () => {
      cargarPlanes();
      cargarMaterias();
    });
  </script>
</body>
</html>