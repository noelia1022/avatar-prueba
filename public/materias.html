<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Avatar - Materias</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
    h1 { color: #2e86de; text-align: center; margin-bottom: 20px; }
    nav { text-align: center; margin-bottom: 30px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    nav a { margin: 0 15px; text-decoration: none; color: #444; font-weight: bold; padding: 8px 15px; border-radius: 4px; transition: all 0.3s; }
    nav a:hover { color: #2e86de; background: #f8f9fa; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #2e86de; color: white; }
    tr:nth-child(even) { background: #f8f9fa; }
    tr:hover { background: #e9ecef; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
    .btn:hover { transform: translateY(-2px); }
    .btn-edit { background: #f39c12; color: white; }
    .btn-deactivate { background: #e74c3c; color: white; }
    .btn-activate { background: #27ae60; color: white; }
    .btn-add { background: #27ae60; color: white; padding: 10px 20px; margin-bottom: 20px; font-size: 16px; }
    .filter-container { display: flex; justify-content: space-between; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 15px; }
    .filter-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    select { padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; }
    label { font-weight: bold; color: #444; }
    .logout-container { position: fixed; top: 20px; right: 20px; background: white; padding: 10px 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; }
    .btn-logout { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .user-info { color: #444; font-weight: 500; }
    .status-active { color: #27ae60; font-weight: bold; }
    .status-inactive { color: #e74c3c; font-weight: bold; }
    .no-data, .loading { text-align: center; padding: 20px; font-style: italic; }
    .loading { color: #2e86de; }
    @media (max-width: 768px) {
      .filter-container { flex-direction: column; }
      .actions { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="logout-container">
    <span class="user-info" id="userName"></span>
    <button class="btn-logout" onclick="logout()">Cerrar sesión</button>
  </div>

  <h1>Gestión de Materias</h1>
  
  <nav>
    <a href="index.html">Inicio</a>
    <a href="usuarios.html">Usuarios</a>
    <a href="estudiantes.html">Estudiantes</a>
    <a href="profesores.html">Profesores</a>
    <a href="planes.html">Planes de estudio</a>
    <a href="matricula.html">Matrícula</a>
    <a href="pagos.html">Pagos</a>
    <a href="configuracion.html">Configuración</a>
  </nav>

  <div class="filter-container">
    <div class="filter-group">
      <button class="btn btn-add" onclick="location.href='agregar_materia.html'">+ Agregar Materia</button>
    </div>
    <div class="filter-group">
      <label for="planFilter">Filtrar por Plan:</label>
      <select id="planFilter" onchange="filtrarMaterias()">
        <option value="0">Todos los planes</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="statusFilter">Estado:</label>
      <select id="statusFilter" onchange="filtrarMaterias()">
        <option value="all" selected>Todos</option>
        <option value="active">Activas</option>
        <option value="inactive">Inactivas</option>
      </select>
    </div>
  </div>

  <table id="materiasTable">
    <thead>
      <tr>
        <th>Código</th>
        <th>Nombre</th>
        <th>Créditos</th>
        <th>Plan de Estudio</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6" class="loading" id="loadingText">Cargando materias...</td></tr>
    </tbody>
  </table>

  <script>
    const token = localStorage.getItem('token');
    let user;
    try {
      user = JSON.parse(localStorage.getItem('user')) || {};
    } catch { user = {}; }

    if(!token) {
      alert('Debe iniciar sesión primero');
      window.location.href = 'index.html';
    } else {
      document.getElementById('userName').textContent = user.nombre || '';
    }

    let todasLasMaterias = [];
    let planesEstudio = [];

    async function cargarPlanes() {
      try {
        const res = await fetch('/api/planes', { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await res.json();
        if(result.success) {
          planesEstudio = result.planes;
          const select = document.getElementById('planFilter');
          select.innerHTML = '<option value="0">Todos los planes</option>';
          planesEstudio.forEach(plan => {
            const opt = document.createElement('option');
            opt.value = plan.PlanID;
            opt.textContent = plan.NombrePlan;
            select.appendChild(opt);
          });
        }
      } catch (err) {
        console.error('Error al cargar planes:', err);
        alert('Error al cargar planes de estudio');
      }
    }

    async function cargarMaterias() {
      try {
        const res = await fetch('/api/materias', { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await res.json();
        if(result.success) {
          todasLasMaterias = result.materias;
          filtrarMaterias();
        } else {
          throw new Error(result.message || 'Error al obtener materias');
        }
      } catch (err) {
        console.error('Error al cargar materias:', err);
        const loadingText = document.getElementById('loadingText');
        loadingText.textContent = 'Error al cargar materias: ' + err.message;
        loadingText.style.color = '#e74c3c';
      }
    }

    function filtrarMaterias() {
      const planID = document.getElementById('planFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      let materiasFiltradas = todasLasMaterias;
      if(planID !== "0") materiasFiltradas = materiasFiltradas.filter(m => m.PlanID == planID);
      if(statusFilter !== "all") {
        const estadoFiltro = statusFilter === "active";
        materiasFiltradas = materiasFiltradas.filter(m => m.Activo === estadoFiltro);
      }

      const tbody = document.querySelector('#materiasTable tbody');
      tbody.innerHTML = '';

      if(materiasFiltradas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="no-data">No se encontraron materias</td></tr>`;
        return;
      }

      materiasFiltradas.forEach(m => {
        const plan = planesEstudio.find(p => p.PlanID == m.PlanID) || {};
        const isActive = m.Activo !== undefined ? m.Activo : true;
        const statusClass = isActive ? 'status-active' : 'status-inactive';
        const statusText = isActive ? 'Activa' : 'Inactiva';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${m.Codigo}</td>
          <td>${m.Nombre}</td>
          <td>${m.Creditos}</td>
          <td>${plan.NombrePlan || 'No asignado'}</td>
          <td class="${statusClass}">${statusText}</td>
          <td class="actions">
            <button class="btn btn-edit" onclick="editarMateria('${m.Codigo}')">Editar</button>
            ${isActive 
              ? `<button class="btn btn-deactivate" onclick="cambiarEstadoMateria('${m.Codigo}', false)">Desactivar</button>`
              : `<button class="btn btn-activate" onclick="cambiarEstadoMateria('${m.Codigo}', true)">Activar</button>`
            }
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function editarMateria(codigo) {
      location.href = `agregar_materia.html?codigo=${codigo}`;
    }

    async function cambiarEstadoMateria(codigo, nuevoEstado) {
      const accion = nuevoEstado ? "activar" : "desactivar";
      if(confirm(`¿Está seguro de ${accion} esta materia?`)) {
        try {
          const res = await fetch(`/api/materias/${codigo}/estado`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ activo: nuevoEstado })
          });
          const result = await res.json();
          if(res.ok && result.success) {
            alert(`Materia ${accion}ada correctamente`);
            cargarMaterias();
          } else {
            alert(`Error al ${accion} materia: ` + (result.message || ''));
          }
        } catch (err) {
          console.error(`Error al ${accion} materia:`, err);
          alert(`Error al ${accion} materia`);
        }
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
      cargarPlanes();
      cargarMaterias();
    });
  </script>
</body>
</html>
