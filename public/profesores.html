<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Avatar - Profesores</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f2f5; padding:20px; }
    h1 { color:#2e86de; text-align:center; }
    nav { text-align:center; margin-bottom:30px; }
    nav a { margin:10px; text-decoration:none; color:#444; font-weight:bold; }
    nav a:hover { color:#2e86de; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:white; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#2e86de; color:white; }
    tr:nth-child(even) { background:#f9f9f9; }
    .actions { display:flex; gap:5px; }
    .btn { padding:5px 10px; border:none; border-radius:3px; cursor:pointer; }
    .btn-edit { background:#f39c12; color:white; }
    .btn-delete { background:#e74c3c; color:white; }
    .btn-add { background:#27ae60; color:white; padding:10px 15px; margin-bottom:20px; }
    .logout-container {
      position: fixed; top: 20px; right: 20px;
      background: white; padding: 8px 15px; border-radius: 5px;
      display: flex; gap: 10px; align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-logout { background:#e74c3c; color:white; padding:5px 10px; border:none; border-radius:3px; cursor:pointer; font-weight:bold; }
    .user-info { color:#444; font-weight:500; }
  </style>
</head>
<body>
  <!-- Botón de cerrar sesión -->
  <div class="logout-container">
    <span class="user-info" id="userName"></span>
    <button class="btn-logout" onclick="logout()">Cerrar sesión</button>
  </div>

  <h1>Gestión de Profesores</h1>

  <nav>
    <a href="index.html">Inicio</a>
    <a href="usuarios.html">Usuarios</a>
    <a href="estudiantes.html">Estudiantes</a>
    <a href="materias.html">Materias</a>
    <a href="planes.html">Planes de estudio</a>
    <a href="matricula.html">Matrícula</a>
    <a href="pagos.html">Pagos</a>
    <a href="configuracion.html">Configuración</a>
  </nav>

  <div style="text-align:right;">
    <button class="btn btn-add" onclick="location.href='agregar_profesor.html'">+ Agregar Profesor</button>
  </div>

  <table id="profesoresTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Teléfono</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Cargando profesores...</td></tr>
    </tbody>
  </table>

  <script>
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');

    if (!token) {
      alert('Debe iniciar sesión primero');
      window.location.href = 'login.html';
    } else {
      document.getElementById('userName').textContent = user?.nombre || 'Usuario';
    }

    // ==== Cargar profesores desde API ====
    async function cargarProfesores() {
      const tbody = document.querySelector('#profesoresTable tbody');
      try {
        const res = await fetch('/api/profesores', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
          alert('Sesión expirada. Por favor, inicie sesión nuevamente.');
          logout();
          return;
        }

        const data = await res.json();
        tbody.innerHTML = '';

        if (!data.success || !data.profesores || data.profesores.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No hay profesores registrados</td></tr>';
          return;
        }

        data.profesores.forEach(prof => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${prof.ProfesorID}</td>
            <td>${prof.Nombre}</td>
            <td>${prof.Correo || '-'}</td>
            <td>${prof.Telefono || '-'}</td>
            <td class="actions">
              <button class="btn btn-edit" onclick="location.href='agregar_profesor.html?id=${prof.ProfesorID}'">Editar</button>
              <button class="btn btn-delete" onclick="eliminarProfesor(${prof.ProfesorID}, '${prof.Nombre}')">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Error:', err);
        tbody.innerHTML = '<tr><td colspan="5">Error al cargar profesores</td></tr>';
      }
    }

    // ==== Eliminar profesor ====
    async function eliminarProfesor(id, nombre) {
      if (!confirm(`¿Está seguro de eliminar al profesor "${nombre}"?`)) return;
      try {
        const res = await fetch(`/api/profesores/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 401) {
          logout();
          return;
        }

        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'Error al eliminar');

        alert('Profesor eliminado correctamente');
        cargarProfesores();
      } catch (err) {
        console.error(err);
        alert('Error: ' + err.message);
      }
    }

    // ==== Logout ====
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    // ==== Init ====
    document.addEventListener('DOMContentLoaded', cargarProfesores);
  </script>
</body>
</html>
