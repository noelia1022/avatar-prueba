<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema Avatar - Matrícula</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .logout-container {
      position: fixed; top: 20px; right: 20px;
      background: white; padding: 8px 15px; border-radius: 5px;
      display: flex; gap: 10px; align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-logout { background:#e74c3c; color:white; padding:5px 10px; border:none; border-radius:3px; cursor:pointer; font-weight:bold; }
    .user-info { color:#444; font-weight:500; }
  </style>
</head>
<body>
<div class="container">
  <!-- Cerrar sesión -->
  <div class="logout-container">
    <span class="user-info" id="userName"></span>
    <button class="btn-logout" onclick="logout()">Cerrar sesión</button>
  </div>

  <header>
    <h1><span class="logo">Avatar</span> Sistema de Matrícula</h1>
  </header>

  <nav>
    <a href="index.html">Inicio</a>
    <a href="usuarios.html">Usuarios</a>
    <a href="estudiantes.html">Estudiantes</a>
    <a href="profesores.html">Profesores</a>
    <a href="materias.html">Materias</a>
    <a href="planes.html">Planes de estudio</a>
    <a href="pagos.html">Pagos</a>
    <a href="configuracion.html">Configuración</a>
  </nav>

  <div class="matricula-container">
    <div class="form-container">
      <h2 class="section-title">Nueva Matrícula</h2>
      <div id="alertBox"></div>

      <form id="matriculaForm">
        <div class="form-group">
          <label for="estudiante">Estudiante:</label>
          <select id="estudiante" required></select>
        </div>
        <div class="form-group">
          <label for="periodo">Periodo Académico:</label>
          <select id="periodo" required></select>
        </div>
        <div class="form-group">
          <label for="tipo">Tipo de Matrícula:</label>
          <select id="tipo" required>
            <option value="Ordinaria">Ordinaria</option>
            <option value="Extraordinaria">Extraordinaria</option>
            <option value="Especial">Especial</option>
          </select>
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary" id="btnIniciar">Iniciar Matrícula</button>
          <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">Cancelar</button>
        </div>
      </form>

      <div class="summary-container" id="resumenMatricula" style="display:none;">
        <h3>Resumen de Matrícula</h3>
        <div class="summary-item"><span>Total de materias:</span> <span id="totalMaterias">0</span></div>
        <div class="summary-item"><span>Total de créditos:</span> <span id="totalCreditos">0</span></div>
        <div class="summary-item summary-total"><span>Total a pagar:</span> <span id="totalCosto">₡0</span></div>
        <div class="summary-item summary-total"><span>Estado:</span> <span class="status-pendiente" id="estadoMatricula">Pendiente</span></div>
      </div>
    </div>

    <div class="materias-container">
      <h2 class="section-title">Materias Disponibles</h2>
      <div id="materiasDisponibles" class="materias-list"></div>

      <h2 class="section-title">Materias Seleccionadas</h2>
      <div id="materiasSeleccionadas" class="materias-list"></div>

      <div style="text-align:right;margin-top:20px;">
        <button id="btnConfirmar" class="btn btn-success" disabled onclick="confirmarMatricula()">Confirmar Matrícula</button>
      </div>
    </div>
  </div>

  <div class="footer">Sistema Avatar © 2025 - CUC</div>
</div>

<script>
let estudianteActual=null, periodoActual=null;
let materiasDisponibles=[], materiasSeleccionadas=[];
const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user') || '{}');

if(!token){
  alert("Debe iniciar sesión");
  window.location.href="login.html";
} else {
  document.getElementById('userName').textContent = user?.nombre || 'Usuario';
}

// Mostrar alerta
function mostrarAlerta(msg,tipo="info"){
  const box=document.getElementById("alertBox");
  box.innerHTML=`<div class="alert alert-${tipo}">${msg}</div>`;
  box.style.display="block";
}

// Cargar estudiantes
async function cargarEstudiantes(){
  try {
    const res=await fetch("/api/estudiantes",{headers:{Authorization:`Bearer ${token}`}});
    if(res.status===401){logout();return;}
    const data=await res.json();
    const sel=document.getElementById("estudiante");
    sel.innerHTML="<option value=''>Seleccione...</option>";
    (data.estudiantes||[]).forEach(e=>{
      sel.innerHTML+=`<option value="${e.estudianteid}">${e.nombre} (${e.cedula})</option>`;
    });
  } catch(err){ mostrarAlerta("Error cargando estudiantes","error"); }
}

// Cargar periodos
async function cargarPeriodos(){
  try {
    const res=await fetch("/api/periodos",{headers:{Authorization:`Bearer ${token}`}});
    if(res.status===401){logout();return;}
    const data=await res.json();
    const sel=document.getElementById("periodo");
    sel.innerHTML="<option value=''>Seleccione...</option>";
    (data.periodos||[]).forEach(p=>{
      sel.innerHTML+=`<option value="${p.periodoid}">${p.nombre} - ${p.anio}</option>`;
    });
  } catch(err){ mostrarAlerta("Error cargando periodos","error"); }
}

// Iniciar matrícula
async function iniciarMatricula(e){
  e.preventDefault();
  estudianteActual=document.getElementById("estudiante").value;
  periodoActual=document.getElementById("periodo").value;
  if(!estudianteActual||!periodoActual)return mostrarAlerta("Seleccione estudiante y periodo","error");

  try {
    const res=await fetch(`/api/materias?periodo=${periodoActual}`,{headers:{Authorization:`Bearer ${token}`}});
    if(res.status===401){logout();return;}
    const data=await res.json();
    materiasDisponibles=data.materias||[];
    mostrarMateriasDisponibles();
    document.getElementById("resumenMatricula").style.display="block";
  } catch(err){ mostrarAlerta("Error cargando materias","error"); }
}

// Mostrar materias
function mostrarMateriasDisponibles(){
  const cont=document.getElementById("materiasDisponibles");
  if(materiasDisponibles.length===0){
    cont.innerHTML="<div class='alert alert-info'>No hay materias disponibles</div>";return;
  }
  cont.innerHTML="";
  materiasDisponibles.forEach(m=>{
    const costo=m.costo||m.creditos*25000;
    cont.innerHTML+=`
      <div class="materia-item">
        <div class="materia-info"><strong>${m.codigo}</strong> - ${m.nombre}<br>
          <small>${m.creditos} créditos</small><br>
          <small>Costo: ₡${costo.toLocaleString("es-CR")}</small>
        </div>
        <div class="materia-actions"><button class="btn btn-primary" onclick="agregarMateria(${m.materiaid})">Agregar</button></div>
      </div>`;
  });
}

// Agregar/Quitar materias
function agregarMateria(id){
  const m=materiasDisponibles.find(x=>x.materiaid===id);
  if(m && !materiasSeleccionadas.find(x=>x.materiaid===id)){
    materiasSeleccionadas.push(m);
    mostrarMateriasSeleccionadas();
    actualizarResumen();
    document.getElementById("btnConfirmar").disabled=false;
  }
}
function quitarMateria(id){
  materiasSeleccionadas=materiasSeleccionadas.filter(x=>x.materiaid!==id);
  mostrarMateriasSeleccionadas();
  actualizarResumen();
  if(materiasSeleccionadas.length===0)document.getElementById("btnConfirmar").disabled=true;
}
function mostrarMateriasSeleccionadas(){
  const cont=document.getElementById("materiasSeleccionadas");
  if(materiasSeleccionadas.length===0){
    cont.innerHTML="<div class='alert alert-info'>No hay materias seleccionadas</div>";return;
  }
  cont.innerHTML="";
  materiasSeleccionadas.forEach(m=>{
    cont.innerHTML+=`
      <div class="materia-item">
        <div class="materia-info"><strong>${m.codigo}</strong> - ${m.nombre} (${m.creditos} créditos)</div>
        <div class="materia-actions"><button class="btn btn-danger" onclick="quitarMateria(${m.materiaid})">Quitar</button></div>
      </div>`;
  });
}

// Resumen
function actualizarResumen(){
  const totalMat=materiasSeleccionadas.length;
  const totalCred=materiasSeleccionadas.reduce((s,m)=>s+(m.creditos||0),0);
  const totalCosto=materiasSeleccionadas.reduce((s,m)=>s+(m.costo||m.creditos*25000),0);
  document.getElementById("totalMaterias").textContent=totalMat;
  document.getElementById("totalCreditos").textContent=totalCred;
  document.getElementById("totalCosto").textContent="₡"+totalCosto.toLocaleString("es-CR");
}

// Confirmar
async function confirmarMatricula(){
  if(!estudianteActual||!periodoActual||materiasSeleccionadas.length===0)
    return mostrarAlerta("Complete todo","error");
  const body={estudianteID:estudianteActual,periodoID:periodoActual,tipoMatricula:document.getElementById("tipo").value,materias:materiasSeleccionadas.map(m=>m.materiaid)};
  try {
    const res=await fetch("/api/matriculas",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify(body)});
    if(res.status===401){logout();return;}
    const data=await res.json();
    if(data.success){
      mostrarAlerta("Matrícula registrada","success");
      document.getElementById("estadoMatricula").textContent="Confirmada";
      document.getElementById("estadoMatricula").className="status-confirmada";
    } else mostrarAlerta("Error: "+data.message,"error");
  } catch(err){ mostrarAlerta("Error al registrar matrícula","error"); }
}

// Reset
function limpiarFormulario(){
  document.getElementById("matriculaForm").reset();
  materiasDisponibles=[];materiasSeleccionadas=[];
  document.getElementById("materiasDisponibles").innerHTML="<div class='alert alert-info'>Seleccione estudiante y periodo</div>";
  document.getElementById("materiasSeleccionadas").innerHTML="<div class='alert alert-info'>No hay materias seleccionadas</div>";
  document.getElementById("btnConfirmar").disabled=true;
  document.getElementById("resumenMatricula").style.display="none";
}

// Logout
function logout(){
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location.href="login.html";
}

// Init
document.addEventListener("DOMContentLoaded",()=>{
  cargarEstudiantes();cargarPeriodos();
  document.getElementById("matriculaForm").addEventListener("submit",iniciarMatricula);
});
</script>
</body>
</html>
