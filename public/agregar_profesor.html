<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Avatar - Gestión de Profesores</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:20px; }
    h1 { color:#2e86de; text-align:center; margin-bottom:20px; }
    nav { text-align:center; margin-bottom:30px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    nav a { margin:0 15px; text-decoration:none; color:#444; font-weight:bold; padding:5px 10px; border-radius:4px; transition:.3s; }
    nav a:hover { color:#2e86de; background:#f8f9fa; }
    .form-container { max-width:600px; margin:auto; background:#fff; padding:25px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    .form-group { margin-bottom:18px; }
    label { display:block; margin-bottom:6px; font-weight:bold; color:#333; }
    input[type="text"], input[type="email"] {
      width:100%; padding:12px; border:1px solid #ddd; border-radius:4px; font-size:16px;
    }
    input:focus { border-color:#2e86de; outline:none; box-shadow:0 0 0 2px rgba(46,134,222,0.2); }
    .btn { padding:12px 20px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:16px; transition:.3s; }
    .btn-primary { background:#2e86de; color:#fff; }
    .btn-primary:hover { background:#1c6bc2; }
    .btn-secondary { background:#95a5a6; color:#fff; margin-right:15px; }
    .btn-secondary:hover { background:#7f8c8d; }
    .error { color:#e74c3c; font-size:14px; margin-top:5px; }
    .success-message { background:#d4edda; color:#155724; padding:12px; border-radius:4px; margin-bottom:20px; display:none; }
    .button-group { display:flex; justify-content:flex-end; margin-top:25px; }
    .required::after { content:" *"; color:#e74c3c; }
    .logout-container { position:fixed; top:20px; right:20px; background:#fff; padding:8px 15px; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,.1); display:flex; gap:10px; align-items:center; }
    .btn-logout { background:#e74c3c; color:#fff; padding:6px 10px; border:none; border-radius:3px; cursor:pointer; font-weight:bold; }
    .user-info { color:#444; font-weight:500; }
  </style>
</head>
<body>
  <!-- Logout -->
  <div class="logout-container">
    <span class="user-info" id="userName"></span>
    <button class="btn-logout" onclick="logout()">Cerrar sesión</button>
  </div>

  <h1 id="pageTitle">Agregar Nuevo Profesor</h1>
  
  <nav>
    <a href="index.html">Inicio</a>
    <a href="usuarios.html">Usuarios</a>
    <a href="estudiantes.html">Estudiantes</a>
    <a href="materias.html">Materias</a>
    <a href="planes.html">Planes de estudio</a>
    <a href="matricula.html">Matrícula</a>
    <a href="pagos.html">Pagos</a>
    <a href="configuracion.html">Configuración</a>
    <a href="profesores.html">Profesores</a>
  </nav>

  <div class="form-container">
    <div id="successMessage" class="success-message">
      Profesor guardado correctamente. Redirigiendo...
    </div>
    
    <form id="profesorForm">
      <input type="hidden" id="profesorId">

      <div class="form-group">
        <label for="nombre" class="required">Nombre completo</label>
        <input type="text" id="nombre" required placeholder="Ingrese el nombre completo">
        <div id="nombreError" class="error"></div>
      </div>

      <div class="form-group">
        <label for="correo">Correo electrónico</label>
        <input type="email" id="correo" placeholder="ejemplo@correo.com">
        <div id="correoError" class="error"></div>
      </div>

      <div class="form-group">
        <label for="telefono">Teléfono</label>
        <input type="text" id="telefono" placeholder="Ingrese el número de teléfono">
        <div id="telefonoError" class="error"></div>
      </div>

      <div class="button-group">
        <button type="button" class="btn btn-secondary" onclick="location.href='profesores.html'">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="submitButton">Guardar Profesor</button>
      </div>
    </form>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const profesorId = urlParams.get('id');
    let isEditMode = false;

    document.addEventListener('DOMContentLoaded', async () => {
      const form = document.getElementById('profesorForm');
      const successMessage = document.getElementById('successMessage');
      const pageTitle = document.getElementById('pageTitle');
      const submitButton = document.getElementById('submitButton');

      // Verificar login
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!token) {
        alert('Debe iniciar sesión primero');
        window.location.href = 'index.html';
        return;
      }
      document.getElementById('userName').textContent = user?.nombre || 'Usuario';

      // Modo edición
      if (profesorId) {
        isEditMode = true;
        pageTitle.textContent = 'Editar Profesor';
        submitButton.textContent = 'Actualizar Profesor';
        try {
          const res = await fetch(`/api/profesores/${profesorId}`, { headers:{'Authorization':`Bearer ${token}`} });
          const result = await res.json();
          if (!res.ok || !result.success) throw new Error(result.message || 'Error al cargar profesor');
          const p = result.profesor;
          document.getElementById('profesorId').value = p.ProfesorID;
          document.getElementById('nombre').value = p.Nombre || '';
          document.getElementById('correo').value = p.Correo || '';
          document.getElementById('telefono').value = p.Telefono || '';
        } catch (err) {
          alert('Error al cargar profesor: '+err.message);
          window.location.href='profesores.html';
        }
      }

      // Guardar/Actualizar
      form.addEventListener('submit', async e => {
        e.preventDefault();
        document.querySelectorAll('.error').forEach(el=>el.textContent='');

        const nombre = document.getElementById('nombre').value.trim();
        const correo = document.getElementById('correo').value.trim();
        const telefono = document.getElementById('telefono').value.trim();

        let valid = true;
        if (!nombre) { document.getElementById('nombreError').textContent='El nombre es obligatorio'; valid=false; }
        if (correo && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo)) {
          document.getElementById('correoError').textContent='Correo inválido'; valid=false;
        }
        if (telefono && !/^[0-9+\-\s()]{8,20}$/.test(telefono)) {
          document.getElementById('telefonoError').textContent='Teléfono inválido'; valid=false;
        }
        if (!valid) return;

        try {
          const method = isEditMode ? 'PUT':'POST';
          const url = isEditMode ? `/api/profesores/${profesorId}` : '/api/profesores';
          const res = await fetch(url,{
            method,
            headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
            body:JSON.stringify({ Nombre:nombre, Correo:correo||null, Telefono:telefono||null })
          });
          const result = await res.json();
          if (res.ok && result.success) {
            successMessage.style.display='block';
            setTimeout(()=>window.location.href='profesores.html',2000);
          } else throw new Error(result.message||'Error en la solicitud');
        } catch(err) {
          alert('Error: '+err.message);
        }
      });
    });

    function logout(){
      localStorage.clear();
      window.location.href='index.html';
    }
  </script>
</body>
</html>
